{%- set lart_forms = true %}
{%- from 'lart_macros.html' import lart_form_pipeline %}
{%- extends 'base.html' %}
{% block title %}LART Survey Client - LSBQ-RML - Community Language Use Behaviour{% endblock %}
{% block headline %}<span id="lsbqRmlAppTitle" data-lsbq-tr="base.appTitle">Language and Social Background Questionnaire (RML)</span>{% endblock %}
{% block head_scripts %}
    <script type="text/javascript" src="/js/lsbq-rml.js"></script>
{% endblock %}
{% block head_styles %}{% endblock %}
{% block drawer_info %}{% endblock %}
{% block drawer_nav_options %}
    <li class="nav-item">
        <a class="nav-link" onClick="discard_attempt()"><i class="bi bi-x-circle"></i>  Discard attempt</a>
    </li>
    <li><hr class="nav-divider"></li>
{% endblock %}
{% block content %}
    <article class="container-fluid p-2">

        <div class="progress m-4">
            <div class="progress-bar bg-info" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width:75%"></div>
        </div>

        <div class="row m-4 text-center">
            <h2 id="lsbqRmlSectionTitle" data-lsbq-tr="club.secTitle">Community Language Use Behaviour</h2>
        </div>

        <form id="surveyCLUBForm" class="needs-validation" autocomplete="off">

            <!-- Template for sliders -->
            <template id="clubSliderTemplate">
                <div data-template-field-prefix="[FieldPrefix]" data-template-field-name="[FieldName]" data-template-field-label="[FieldLabel]" data-template-field-hint="[FieldHint]" data-template-field-required="true">
                    <div id="[FieldPrefix]Instance-[FieldName]">
                        <div class="row mb-1">
                            <label id="[FieldPrefix]Label-[FieldName]" for="[FieldPrefix]-[FieldName]" class="col-2 col-form-label text-end">
                                <span>[FieldLabel]</span><br />
                                <span class="text-muted" id="[FieldPrefix]Hint-[FieldName]">[FieldHint]</span><br />
                            </label>
                            <div class="col-9 mt-2">
                                <input type="range" class="form-range d-block" min="0" max="100" step="any" id="[FieldPrefix]-[FieldName]" required />
                                <div class="invalid-feedback invalid-range" data-lsbq-tr="base.sliderFeedback">Please move the slider at least once.</div>
                            </div>
                            <div class="col-1" id="[FieldPrefix]NotApplicableOption-[FieldName]">
                                <p  class="text-muted d-inline-block ps-2"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="left"
                                    data-bs-html="true"
                                    title="Please mark this box <i>only</i> if you do not use either of these languages in the described context."
                                >
                                    <input  class="form-check-input align-text-top"
                                            type="checkbox"
                                            id="[FieldPrefix]NotApplicable-[FieldName]"
                                            name="[FieldPrefix]NotApplicable-[FieldName]"
                                    />
                                    <label class="form-check-label" for="[FieldPrefix]NotApplicable-[FieldName]" data-lsbq-tr="base.notApplicableAbbr">N/A</label>
                                </p>
                            </div>
                        </div>
                    </div>
                    <script type="text/javascript">
                        activateClubSliderTemplate(document.currentScript.parentElement);
                    </script>
                </div>
            </template>
            <script type="text/javascript">
                booteel.util.stringMultiReplace = function (stringObject, replacements) {
                    for (key in replacements) {
                        stringObject = stringObject.replace(key, replacements[key]);
                    }
                    return stringObject;
                }
                booteel.util.replaceInDOM = function (rootNode, replacements) {
                    // Replace placeholders on all attributes in Elements
                    if (rootNode instanceof Element) {
                        const attrNames = rootNode.getAttributeNames();
                        for (const attrName of attrNames) {
                            let attrValue = rootNode.getAttribute(attrName);
                            if ( typeof(attrValue) == 'string' ) {
                                rootNode.setAttribute(attrName, booteel.util.stringMultiReplace(attrValue, replacements));
                            }
                        }
                    }
                    // Replace placeholders inside CData nodes
                    if (rootNode instanceof CharacterData) {
                        let cData = rootNode.data;
                        rootNode.data = booteel.util.stringMultiReplace(cData, replacements);
                    }
                    for (const childNode of rootNode.childNodes) {
                        booteel.util.replaceInDOM(childNode, replacements)
                    }
                }
                function activateClubSliderTemplate(templateElement) {
                    // Get data for the slider
                    if (!templateElement) {
                        booteel.logger.error("Template instance could not retreive its container.");
                    }
                    const templateData = templateElement.dataset;
                    const fieldPrefix = templateData.templateFieldPrefix;
                    const fieldName = templateData.templateFieldName;
                    const fieldLabel = templateData.templateFieldLabel;
                    let fieldHint = templateData.templateFieldHint;
                    let fieldRequired = templateData.templateFieldRequired;
                    if ( fieldPrefix == "[FieldPrefix]" || fieldName == "[FieldName]" || fieldLabel == "[FieldLabel]" ) {
                        booteel.logger.error(
                            "Template instance is missing one or more required data attributes (templateFieldPrefix, templateFieldName, templateFieldLabel)."
                        );
                    }
                    if ( !fieldHint || fieldHint == "[FieldHint]" ) {
                        fieldHint = "";
                    }
                    if ( !fieldRequired || fieldRequired == "false" ) {
                        fieldRequired = false;
                    } else {
                        fieldRequired = true;
                    }
                    // Replace placeholder strings in template
                    booteel.util.replaceInDOM(
                        templateElement,
                        {
                            "[FieldPrefix]": fieldPrefix,
                            "[FieldName]": fieldName,
                            "[FieldLabel]": fieldLabel,
                            "[FieldHint]": fieldHint
                        }
                    );
                    // Remove or activate NA option
                    const notApplicableOption = document.getElementById(`${fieldPrefix}NotApplicableOption-${fieldName}`);
                    if (fieldRequired) {
                        notApplicableOption.parentNode.removeChild(notApplicableOption);
                    } else {
                        const tt = new bootstrap.Tooltip(notApplicableOption.firstElementChild);
                        lart.forms.conditionalDisable(`${fieldPrefix}NotApplicable-${fieldName}`, `${fieldPrefix}-${fieldName}`, 'on', 'equal');
                        lart.forms.conditionalDisable(`${fieldPrefix}NotApplicable-${fieldName}`, `${fieldPrefix}Label-${fieldName}`, 'on', 'equal');
                    }                    
                }
            </script>

            <!-- 13. Language use at various life stages -->
            <section class="m-4">
                <div class="row mb-1">
                    <div class="col-auto">
                        <p data-lsbq-tr="club.lifeStageInstructions">
                            Please indicate which language or dialect you most frequently heard or used
                            in the following life stages, both inside and outside home.
                        </p>
                    </div>
                </div>
                <div class="row mb-0">
                    <div class="col-2"></div>
                    <div class="col-3 text-start" data-lsbq-tr="club.onlyMajorityLanguage">
                        Only [MajorityLanguage]
                    </div>
                    <div class="col-3 text-center" data-lsbq-tr="club.halfHalf">
                        Half/Half
                    </div>
                    <div class="col-3 text-end" data-lsbq-tr="club.onlyRML">
                        Only [RML]
                    </div>
                </div>
                <div id="lifeStageSlot">
                    <!-- Placeholder dynamically filled with copies of languageUseObligatoryTemplate -->
                </div>
            </section>

            <!-- Form submission -->
            <div class="row text-end p-3 m-4">
                <div clas="col">
                    <button type="submit" class="btn btn-primary btn-lg btn-action shadow" data-lsbq-tr="base.next">Next</button>
                </div>
            </div>

        </form>

    </article>
{% endblock %}
{% block tail_scripts %}
    <script type="text/javascript">
        clubDefaults = {
            "lifeStageFields": {
                "infancy":      ["Infancy"],
                "nurseryAge":   ["Nursery age"],
                "primaryAge":   ["Primary age"],
                "secondaryAge": ["Secondary age"]
            },
            "withPeopleNowFields": {
                "parents":          ["Parents"],
                "children":         ["Children"],
                "siblings":         ["Siblings"],
                "grandparents":     ["Grandparents"],
                "otherRelatives":   ["Other relatives"],
                "partner":          ["Partner"],
                "friends":          ["Friends"],
                "flatmates":        ["Flat/housemates"],
                "neighbours":       ["Neighbours"]
            },
            "withPeopleEarlyLifeFields": {
                "parents":          ["Parents"],
                "siblings":         ["Siblings"],
                "grandparents":     ["Grandparents"],
                "otherRelatives":   ["Other relatives"],
                "friends":          ["Friends"],
                "neighbours":       ["Neighbours"]
            },
            "situationFields": {
                "home":         ["Home"],
                "school":       ["School"],
                "work":         ["Work"],
                "socialising":  ["Socialising"],
                "religion":     ["Religion"],
                "leisure":      ["Leisure activities", "hobbies, sports, volunteering, gaming, …"],
                "commercial":   ["Commercial", "shopping, restaurants, …"],
                "public":       ["Public affairs", "healthcare services, banks, government, council, …"]
            },
            "activityFields": {
                "reading":          ["Reading"],
                "emailing":         ["Emailing"],
                "texting":          ["Texting"],
                "socialMedia":      ["Social media"],
                "notes":            ["Notes", "shopping list, memos, notes, …"],
                "traditionalMedia": ["TV, films, radio"],
                "internet":         ["Internet"],
                "praying":          ["Praying"]
            }
        }
        // Translate form for specific version
        lsbqRml.tr.load(lsbqRml.instance.getId(), ['club']);
        lsbqRml.tr.registerObserver('surveyCLUBForm');
        lsbqRml.tr.registerObserver('lsbqRmlSectionTitle');
        lsbqRml.tr.registerObserver('lsbqRmlAppTitle');
        // Dynamically insert rating scales
        const clubSliderTemplate = document.getElementById('clubSliderTemplate');
            // clubSliderTemplate.firstElementChild.dataset defaults:
            // data-template-field-prefix="[FieldPrefix]"
            // data-template-field-name="[FieldName]"
            // data-template-field-label="[FieldLabel]"
            // data-template-field-hint="[FieldHint]"
            // data-template-field-required="true"
        const lifeStageSlot = document.getElementById('lifeStageSlot');
        for (const fieldName in clubDefaults.lifeStageFields) {
            const clone = clubSliderTemplate.content.firstElementChild.cloneNode(true);
            const fieldLabel = clubDefaults.lifeStageFields[fieldName][0];
            const fieldHint = clubDefaults.lifeStageFields[fieldName].length > 1 ? clubDefaults.lifeStageFields[fieldName][1] : "";
            clone.dataset.templateFieldPrefix = "lifeStage";
            clone.dataset.templateFieldName = fieldName;
            clone.dataset.templateFieldLabel = fieldLabel;
            clone.dataset.templateFieldHint = fieldHint;
            clone.dataset.templateFieldRequired = "true";
            lifeStageSlot.appendChild(clone);
        }
        lart.forms.monitorRangeInputs('lifeStageSlot');
    </script>
    {{ lart_form_pipeline('surveyCLUBForm', '_lsbqrml_setclub') }}
{% endblock %}