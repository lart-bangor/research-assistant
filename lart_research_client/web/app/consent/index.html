{%- from 'lart_macros.html' import lart_form_pipeline %}
{% extends 'base.html' %}
{% block title %}LART Research Client - Consent{% endblock %}
{% block headline %}LART Research Client - Consent{% endblock %}
{% block head_styles %}
<style type="text/css">
    main .btn-primary {
        min-width: 50%;
    }
    #consentForm ol { color: #0000cd; }

    #consentForm {
        display: none;
    }
    
</style>
{% endblock %}
{% block head_scripts %}
    <script type="text/javascript">
               
        function loadSurveyVersions() {
            availableVersions = eel._lsbqrml_getversions()(populateSurveyVersions);     // this will probably need to be changed to a more generic "survey_rml_get_versions", 
                                                                                        // or hard-coded for each questionnaire.
                }
            
        function populateSurveyVersions(versions) {
            select = document.getElementById('selectSurveyVersion');
            for(version in versions) {
                option = document.createElement('option');
                option.setAttribute('value', version);
                option.appendChild(document.createTextNode(versions[version]))
                select.appendChild(option);
            }
        }

        
        function showStudyInfo() {
            const fetch_version = document.getElementById("selectSurveyVersion");
            const fetch_partId = document.getElementById("participantId");
            const version = fetch_version.value;
            const partId = fetch_partId.value;
            if (partId == "" || partId == null) {
                    alert("Please provide a valid Participant ID.");
                return false;
            } else {
                hideBtn();
                document.getElementById("partId").value = partId; //pass partId on to consent form for processing
                console.log("Selected version: " + version);
                console.log("Participant ID: " + partId);
                jsonFile = "versions/" + version + ".json";  //set filename based on selected version
                fetch(jsonFile)
                    .then(response => response.json())
                    .then(data => output_info(data));  //pass teh contents of jsonFile to output_info()
            }
        }
        
        // Instructions & check button to be outputed depending on language selection
        function output_info(intface) {
            //# Output participant informtion sheet & informed consent #//
            const iterableInterface = Object.values(intface.versionInfo); //turn object into array so that it can be iterated through with numbers (to establish label + Info pairs)
            const checkboxInfo = intface.confirmation;
            const confirmLabel = checkboxInfo.confirm;
            const confirmStatement = checkboxInfo.confirmTxt;
            const confirmWarnFeedback = checkboxInfo.confirmWarn;
            const btnLabel = checkboxInfo.btnTxt;
            let listItems = iterableInterface.length;

            const studyInfoElement = document.getElementById('studyInfo');
            studyInfoElement.innerHTML =  `<div class="row text-center">
                                            <h4 class="col h-5">${intface.base.consentHeader}</h4>
                                            </div>
                                            <ol id="studyInfoList"></ol>`;

            const studyInfoListElement = document.getElementById('studyInfoList');

            for (let i = 0; i < iterableInterface.length; i+=2) {  // adding 2 to i in order to move to next label-info pair
                label = iterableInterface[i];
                info = iterableInterface[i+1];
                const htmlCode = `<li>${label}<p class="text-body">${info}</p></li>`;
                studyInfoListElement.innerHTML += htmlCode;
                }

            document.getElementById("consentLabel").innerHTML = "<b>" + confirmLabel + ": </b>";
            document.getElementById("confirmStatement").innerHTML = confirmStatement;
            document.getElementById("confirmFeedback").innerHTML = confirmWarnFeedback;

            //# Output Eigibility info #//
            let startingNumber = listItems / 2 + 1;
            const studyEligibilityElement = document.getElementById('studyEligibility');        //output eligibility header
            studyEligibilityElement.innerHTML = `<br /><div class="row text-center">
                                                    <h4 class="col h-5">${intface.base.eligibilityHeader}</h4>
                                                </div>
                                                <ol id="studyEligibilityList" start="` + startingNumber + `">
                                                    <li>${intface.base.eligibilityLabel}
                                                        <ul class="text-body" id="eligCriteriaList"></ul>
                                                    </li>
                                                </ol>`;
            const eligibilityList = intface.eligibilityCriteria;                           // loop thorugh object to output list of eligibility criteria
            const eligCriteriaListElement = document.getElementById('eligCriteriaList');
            for (const key in eligibilityList) {
                const htmlEligCode = `<li>${eligibilityList[key]}</li>`;
                eligCriteriaListElement.innerHTML += htmlEligCode;
            }
            document.getElementById("eligibilityLabel").innerHTML = "<b>" + intface.eligibilityConfirm.eligConfirmLabel + "</b>";
            document.getElementById("confirmEligibility").innerHTML = intface.eligibilityConfirm.eligConfirmTxt;
            document.getElementById("confirmEligibilityFeedback").innerHTML = intface.eligibilityConfirm.eligConfirmWarn;
            
            //# Overall confirmation button #//
            document.getElementById("confirmBtn").innerHTML = btnLabel;
            show_form();
        }

                
        function show_form() {
            document.getElementById("consentForm").style.display = "block";             
        }

        function hideBtn() {
            const btn = document.getElementById('hidden-div');
            btn.style.display = 'none';

        }

        
    </script>
{% endblock %}
{% block drawer_info %}{% endblock %}
{% block drawer_nav_options %}
    <li class="nav-item">
        <a class="nav-link" onClick="window.location = 'index.html'";><i class="bi bi-x-circle"></i>  Discard attempt</a>
    </li>
    <li><hr class="nav-divider"></li>
{% endblock %}
{% block content %}
    <article class="p-2">

        <div class="row m-4 text-center">
            <div class="col">
                <h2>Participant Consent</h2>
            </div>
        </div>

        <form id="consentSelectForm" class="needs-validation">

            <!-- Language version -->
            <section class="m-4">
                <div class="mb-3">
                    <label for="selectSurveyVersion" class="form-label">Select language version:</label>
                    <select id="selectSurveyVersion" class="form-select" required>
                    </select>
                    <script type="text/javascript">
                        loadSurveyVersions();
                    </script>
                    <div class="invalid-feedback">
                        <p>Please select one of the available versions.</p>
                    </div>
                </div>
            </section>

            <!-- Participant details -->
            <section class="m-4">
                <div class="mb-3">
                    <label for="participantId" class="form-label">Participant ID:</label>
                    <input type="text" class="form-control" id="participantId" aria-describedby="participantIdHelp" pattern="[A-Za-z0-9]{3,10}" required autocomplete="off" />
                    <div id="participantIdHelp" class="form-text">Enter the participantâ€™s pre-assigned ID.</div>
                    <div class="invalid-feedback">
                        <p>Please provide a valid Participant ID The ID can only contain letters and numbers (no spaces, hyphens, etc.), and should not contain personally identifiable information (such as a name) in order to protect the confidentiality of the collected data.</p>
                    </div>
                </div>
            </section>
        </form>
    </article>

    <!-- Activate version -->
    <article class="p-2">

        <!-- Displaying consent form -->
        <div id="consentForm">
            <form id="partConsent" class="needs-validation">

                <!-- Consent form -->
                <section class="m-4">
                    <div id="studyInfo"></div>
                    <div class="mb-3">
                        <p class="form-label" style="margin-left:0" id="consentLabel"> </p>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="informedConsent" required autocomplete="off" />
                            <label class="form-check-label" for="informedConsent" id="confirmStatement"> 
                            </label>
                            <div class="invalid-feedback"><p id="confirmFeedback"><p>
                            </div>
                        </div> 
                    </div>
                </section>

                <!-- Eligibility criteria -->
                <section class="m-4">
                    <div id="studyEligibility"></div>
                    <div class="mb-3">
                        <p class="form-label" style="margin-left:0" id="eligibilityLabel"> </p>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="eligibilityConfirmation" required autocomplete="off" />
                            <label class="form-check-label" for="eligibilityConfirmation" id="confirmEligibility"> 
                            </label>
                            <div class="invalid-feedback"><p id="confirmEligibilityFeedback"><p>
                            </div>
                        </div> 
                    </div>
                </section>
                
                <!-- Form submission -->
                <div class="row text-center p-3 m-4">
                    <div class="col">
                        <input type="hidden" id="partId" /> <!-- this is hidden & gets filled by JS within showStudyInfo()-->
                        <button type="submit" class="btn btn-primary btn-lg btn-action shadow" id="confirmBtn"></button>
                    </div>
                </div>
            
            </form>
        </div>

        <!-- Activate version   -->
        <div class="row text-center p-3 m-4" id="hidden-div">
            <div class="col">
                <button class="btn btn-primary btn-lg btn-action shadow" onclick="showStudyInfo();">Start</button>
            </div>
        </div>

    </article>
{% endblock %}
{% block tail_scripts %}
<script type="text/javascript">
    lart.forms.requireValidation(true);
    lart.forms.registerPipeline(
        'partConsent',
        async function(data) {
            let success = await eel.record_consent(data)();
            console.log("tail script: " + success);
        }
    );
</script>
{% endblock %}