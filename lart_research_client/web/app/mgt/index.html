{%- from 'lart_macros.html' import lart_form_pipeline %}
{% extends 'base.html' %}
{% block title %}LART Research Client - MGT(RML){% endblock %}
{% block headline %}LART Research Client - MGT(RML){% endblock %}
{% block head_styles %}
<style type="text/css">
    
    #consentForm ol { color: #0000cd; }

    #consentForm {
        display: none;
    }
    
</style>
{% endblock %}
{% block head_scripts %}
<script type="text/javascript">

function loadSurveyVersions() {
    availableVersions = eel._lsbqrml_getversions()(populateSurveyVersions);     // this will probably need to be changed to a more generic "survey_rml_get_versions", 
                                                                                      // or hard-coded for each questionnaire.
    }
            
function populateSurveyVersions(versions) {
    select = document.getElementById('selectMgtVersion');
        for(version in versions) {
            option = document.createElement('option');
            option.setAttribute('value', version);
            option.appendChild(document.createTextNode(versions[version]))
            select.appendChild(option);
        }
    }

        
function showMgt() {
    const fetch_version = document.getElementById("selectMgtVersion");
    const fetch_partId = document.getElementById("participantId");
    const version = fetch_version.value;
    const partId = fetch_partId.value;
    console.log("Selected version: " + version);
    console.log("Participant ID: " + partId);
    jsonFile = "versions/" + version + ".json";  //set filename based on selected version
    console.log("json file is: ", jsonFile);
    hideInitForm();
    fetch(jsonFile)
        .then(response => response.json())
        .then(data => displayMgt(data));  //pass teh contents of jsonFile to output_info()
    }
    
        
function displayMgt(data) {
    console.log("data is ", data);
    const headerElement = document.getElementById("language_header");
    const sliderElement = document.getElementById("slider_info");
    const btnElement = document.getElementById("btnNext");
    const mgtElement = document.getElementById('mgtRatingScales');
    const headerTxt = data.base.header;
    const agree = data.base.agreement;
    const disagree = data.base.disagreement;
    const sliderTxt = data.base.sliderInfo;
    const sliderWarn = data.base.sliderWarn;
    const btnTxt = data.base.nextBtn;
    headerElement.innerHTML =  headerTxt;
    sliderElement.innerHTML =  " " + sliderTxt;
    btnElement.innerHTML = btnTxt;
    
    itemList = data.mgtItems;
    mgtAudioList = data.mgtAudioList;

    console.log("audio list is: ", mgtAudioList);
    
    console.log("Items = ", itemList);
    console.log("type of mgtItems: ", typeof(itemList));
    let itemsLen = itemList.length;
    let code = "<ul>";
    for (let i = 0; i < itemsLen; i++) {
        code += "<div class='row mb-0'>" +
                    "<div class='col-2'></div>" +
                    "<div class='col-5 text-start'><div style = 'font-size: small'>" + agree + "</div></div>" +
                    "<div class='col-5 text-end'><div style = 'font-size: small'>" + disagree + "</div></div>" +
                "</div>" +
                "<div class='row mb-1'>" +
                "<label for='" + itemList[i] + "_" + "fetchGuiseName();" + "' class='col-2 col-form-label'>" +  //s will pull from a variable once we have the info about which recording is being judged
                    itemList[i] + 
                "</label>" +
                "<div class='col-10 mt-2'>" +
                    "<input type='range' class='form-range d-block' min='0' max='100' step='any' id='" + itemList[i] + "_" + "currentGuiseName" + "' required />" +
                    "<div class='invalid-feedback invalid-range'>" + sliderWarn + "</div>" +
                "</div>" +
            "</div>" + 
            "<div><p><br /><br /><br /><br /></p></div>";
            
       
                               
        }
    mgtElement.insertAdjacentHTML('beforeend', code);
    playGuise();
    }


                
 function show_form() {
    document.getElementById("consentForm").style.display = "block";             
    }

function hideInitForm() {
    const form = document.getElementById('mgtToggleForm');
    const btn = document.getElementById('toggle-btn');
    form.style.display = 'none';
    btn.style.display = 'none';
    }

function playGuise() {
    //console.log("audio path is ", audioFile);
    console.log("currently playing...:", mgtAudioList[0]);
    const audio = document.getElementById("guiseAudio");
    audio.play();

}

function fetchAudio() {
    currentFile = String(window.location.pathname);
    console.log("currentFile is: ", currentFile);
    ext = currentFile.search("index.html");
    console.log("ext is: " , ext);
    currentLocation = currentFile.slice(0, ext);
    console.log("current location is: ", currentLocation);
    audioFile = currentLocation + "audio files/" + mgtAudioList[0];
    console.log("audio file is: ", audioFile);
    return audioFile;
}

    </script>
{% endblock %}
{% block drawer_info %}{% endblock %}
{% block drawer_nav_options %}
    <li class="nav-item">
        <a class="nav-link" onClick="window.location = 'index.html'";><i class="bi bi-x-circle"></i>  Discard attempt</a>
    </li>
    <li><hr class="nav-divider"></li>
{% endblock %}
{% block content %}
    <article class="p-2">

        <div class="row m-4 text-center">
            <div class="col">
                <h2>MGT speaker rating</h2>
            </div>
        </div>

        <div id = "mgtToggleForm">
        <form id="mgtSelectForm" class="needs-validation">

            <!-- Language version -->
            <section class="m-4">
                <div class="mb-3">
                    <label for="selectMgtVersion" class="form-label">Select language version:</label>
                    <select id="selectMgtVersion" class="form-select" required>
                    </select>
                    <script type="text/javascript">
                        loadSurveyVersions();
                    </script>
                    <div class="invalid-feedback">
                        <p>Please select one of the available versions.</p>
                    </div>
                </div>
            </section>

            <!-- Participant details -->
            <section class="m-4">
                <div class="mb-3">
                    <label for="participantId" class="form-label">Participant ID:</label>
                    <input type="text" class="form-control" id="participantId" aria-describedby="participantIdHelp" pattern="[A-Za-z0-9]{3,10}" required autocomplete="off" />
                    <div id="participantIdHelp" class="form-text">Enter the participantâ€™s pre-assigned ID.</div>
                    <div class="invalid-feedback">
                        <p>Please provide a valid Participant ID The ID can only contain letters and numbers (no spaces, hyphens, etc.), and should not contain personally identifiable information (such as a name) in order to protect the confidentiality of the collected data.</p>
                    </div>
                </div>
            </section>
        </div>
        </form>
    </article>
 <!-- This is where the MGt main body begins -->
 <section id="mgtBody">

    <!-- Progress bar-->    
<div class="progress">
    <div class="progress-bar bg-info" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="width:0%"></div>
</div>
<div class="row m-2 text-center">
    <h2></h2>
</div>

<audio id="guiseAudio"></audio>

<form id="mgtForm" class="needs-validation"> <!-- action="part2.html">-->

    <!-- Name language statement to agree with... -->
    <div class="row mt-5 mb-0">
        <div class="col"><h4><p id="language_header">
                </p>
                </h4>
            
        </div>
    </div>

    <!-- Instructions -->
    <div class="row mt-0 mb-0">
        <div class="col">
            <p class="help-block p-2 text-muted"><i class="bi-info-circle text-info" id="slider_info"></i> 
            </p>
        </div>
    </div>

    <div id="mgtRatingScales">
        <!-- Placeholder where JavaScript will insert sliders -->
    </div>
                       
    <!-- Form submission -->
    <div class="row text-end p-3">
        <div clas="col">
            <button class="btn btn-primary btn-lg btn-action shadow" id="btnNext">
                
                
            </button>
        </div>
    </div>
</form>
</section>

<!-- Activate version   -->
    <div class="row text-center p-3 m-4" id="toggle-btn">
        <div class="col">
        <button class="btn btn-primary btn-lg btn-action shadow" onclick="showMgt();">Start</button>
        </div>
    </div>
</article>

{% endblock %}
{% block tail_scripts %}
<script type="text/javascript">
    lart.forms.requireValidation(true);
    lart.forms.registerPipeline(
        'partConsent',
        async function(data) {
            let success = await eel.record_consent(data)();
            console.log("tail script: " + success);
        }
    );
</script>
{% endblock %}